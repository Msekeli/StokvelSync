@page "/register"
@using StokvelSync.Shared
@using StokvelSync.Client.Components
@inject IHttpClientFactory ClientFactory
@inject NavigationManager Nav

<div class="container py-5">
    <div class="form-wrapper shadow-lg mx-auto">
        @* Progress Bar *@
        <div class="progress mb-4" style="height: 8px;">
            <div class="progress-bar" style="width: @(currentStep == 1 ? "50%" : "100%")"></div>
        </div>

        <EditForm Model="member" OnValidSubmit="HandleRegistration">
            <DataAnnotationsValidator />

            @if (currentStep == 1)
            {
                <h2 class="fw-bold mb-4">Personal Details</h2>
                
                <div class="mb-3">
                    <label class="form-label small fw-bold">Full Name & Surname</label>
                    <InputText @bind-Value="member.FullName" class="form-control custom-input" placeholder="e.g., Msekeli Dlamini" />
                    <ValidationMessage For="@(() => member.FullName)" class="text-danger small" />
                </div>

                <div class="mb-3">
                    <label class="form-label small fw-bold">Email Address</label>
                    <InputText @bind-Value="member.Email" class="form-control custom-input" placeholder="name@email.com" />
                    <ValidationMessage For="@(() => member.Email)" class="text-danger small" />
                </div>

                <div class="mb-4">
                    <label class="form-label small fw-bold">WhatsApp Number</label>
                    <InputText @bind-Value="member.WhatsAppNumber" class="form-control custom-input" placeholder="083 123 4567" />
                    <ValidationMessage For="@(() => member.WhatsAppNumber)" class="text-danger small" />
                </div>

                <button type="button" class="btn btn-primary-custom w-100 py-3" @onclick="NextStep">
                    Next: Pick My Columns <i class="bi bi-arrow-right ms-2"></i>
                </button>
            }
            else
            {
                <h2 class="fw-bold mb-4">Your Savings Goals</h2>
                <p class="text-muted small mb-4 text-uppercase fw-bold">Select 2 or more columns from the table</p>

                <TierSelector @bind-SelectedTiers="member.SelectedTiers" />
                <ValidationMessage For="@(() => member.SelectedTiers)" class="text-danger small mt-2" />

                <div class="d-flex gap-2 mt-5">
                    <button type="button" class="btn btn-outline-secondary px-4" @onclick="PrevStep">Back</button>
                    <button type="submit" class="btn btn-primary-custom flex-grow-1 py-3">Finish & Join Group</button>
                </div>
            }
        </EditForm>
    </div>
</div>

@code {
    private Member member = new();
    private int currentStep = 1;

    private void NextStep() => currentStep = 2;
    private void PrevStep() => currentStep = 1;

    private async Task HandleRegistration()
    {
        if (member.SelectedTiers.Count < 1) return;

        var client = ClientFactory.CreateClient("AzureApi");
        await client.PostAsJsonAsync("AddMember", member);
        Nav.NavigateTo("/login");
    }
}